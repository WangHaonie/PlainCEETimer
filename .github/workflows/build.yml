name: PlainCEETimer CI/CD Builder

on:
  push:
    branches:
      - main
    paths:
      - 'PlainCEETimer/**'
      - 'PlainCEETimer.Natives/**'
      - 'PlainCEETimer.Setup/**'

jobs:
  build:
    permissions: write-all
    runs-on: windows-2022 # https://github.com/actions/runner-images?tab=readme-ov-file#available-images
    steps:
      - name: Checkout
        uses: actions/checkout@v4 # https://github.com/actions/checkout
        
      - name: Install NuGet
        uses: nuget/setup-nuget@v2 # https://github.com/NuGet/setup-nuget?tab=readme-ov-file#basic
        
      - name: Install MSBuild
        uses: microsoft/setup-msbuild@v2 # https://github.com/microsoft/setup-msbuild?tab=readme-ov-file#example-usage
        
      - name: Restore Solution
        run: nuget restore
        
      - name: Build Project
        run: msbuild /p:Configuration=Release

      - name: Build Setup
        run: makensis PlainCEETimer.Setup/Setup.nsi
      
      - name: Delete Previous Pre-Release
        uses: 8Mi-Tech/delete-release-assets-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: Preview
          deleteOnlyFromDrafts: false

      - name: Add Tag
        uses: richardsimko/update-tag@v1
        with:
          tag_name: Preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pre-Release Content
        run: |
          Start-Process -FilePath ".github\workflows\getdate.exe" -RedirectStandardOutput "date.txt" -NoNewWindow -Wait
          $Date = Get-Content ".\date.txt"
          $Content = "## ♻️ 自动构建版本
          **🌏 构建日期**
          + ${Date}
          
          **📢 注意事项**
          + 自动构建版本的功能可能不稳定，不推荐作为长期使用
          + 自动构建版本的更新频率高，且该渠道的版本不支持自动检查更新，需用户主动到此页面下载最新版本
          + 版本号沿用上一个正式版的版本号，确保自动构建版在下一个正式版发布时可以自动更新" >content.txt

      - name: Upload to Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: Preview
          files: |
            PlainCEETimer.Setup/*.exe
          prerelease: true
          body_path: content.txt
