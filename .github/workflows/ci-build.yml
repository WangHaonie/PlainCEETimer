name: CI Build

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/ci-build.yml'
      - '.github/triggers/ci-release'
      - 'src/**'

jobs:
  build:
    permissions: write-all
    runs-on: windows-2022
    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Install cloc
        run: choco install cloc -y
        
      - name: Cache NuGet Packages
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.NUGET_PACKAGES }}
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - id: read_version
        name: Get Mainline Version
        run: |
          $ver = (Get-Content -Raw -Encoding UTF8 ".github/triggers/ci-release").Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$ver"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "sha=$($env:GITHUB_SHA.Substring(0, 7))"

      - name: Generate Pre-Release Content
        run: |
          $Date = [DateTime]::UtcNow.AddHours(8.0)
          $($Date.ToString("yyyy-MM-dd'T'HH:mm:ss'Z'")) >date.txt
          $Culture = [System.Globalization.CultureInfo]::GetCultureInfoByIetfLanguageTag("zh-CN")
          $Timestamp = [Math]::Truncate($Date.Ticks / 10000000 - 55287792000)

          $Content = "## â™»ï¸ è‡ªåŠ¨æž„å»ºç‰ˆæœ¬
          **ðŸŒ æž„å»ºæ—¥æœŸ**
          + $($Date.ToString("yyyy'-'MM'-'dd dddd HH':'mm':'ss", $Culture)) (ä¸­å›½æ ‡å‡†æ—¶é—´)

          **ðŸŽ¯ æž„å»ºå†…å®¹**
          + è¯¦è§ [${{ steps.read_version.outputs.sha }}](https://github.com/WangHaonie/PlainCEETimer/commit/${{ steps.read_version.outputs.sha }})
          
          **âš ï¸ æ³¨æ„äº‹é¡¹**
          + è‡ªåŠ¨æž„å»ºç‰ˆæœ¬çš„åŠŸèƒ½å¯èƒ½ä¸ç¨³å®šï¼Œä¸æŽ¨èä½œä¸ºé•¿æœŸä½¿ç”¨
          + è‡ªåŠ¨æž„å»ºçš„ç‰ˆæœ¬å·æ²¿ç”¨ä¸Šä¸€ä¸ªæ­£å¼ç‰ˆçš„ç‰ˆæœ¬å·ï¼Œç¡®ä¿åœ¨ä¸‹ä¸€ä¸ªæ­£å¼ç‰ˆå‘å¸ƒæ—¶å¯ä»¥èŽ·å–åˆ°æ›´æ–°" >content.txt

          $AppInfo = "
          namespace PlainCEETimer.Modules;
          internal static class AppInfo
          {
              public const string Version = `"${{ steps.read_version.outputs.version }}`";
              public const string CommitSHA = `"${{ steps.read_version.outputs.sha }}`";
              public const string BuildDate = `"$($Date.ToString("yyyy/M/d"))`";
              public const long Timestamp = $Timestamp;
          }" >src\PlainCEETimer\Modules\AppInfo.cs

          $SetupPath = "src/PlainCEETimer.Setup/Setup.nsi"
          $SetupScript = Get-Content -Encoding UTF8 $SetupPath
          $SetupScript[0] = "!define SETUP_FILENAME_NO_V `"${{ steps.read_version.outputs.version }}`""
          Set-Content -Path $SetupPath -Value $SetupScript -Encoding UTF8
        
      - name: Restore & Build Project
        working-directory: ./src/
        run: msbuild /r /m /p:RestoreLockedMode=true /p:Configuration=Release /p:Platform=x64 /p:BuildInParallel=true

      - name: Build Setup
        run: makensis /INPUTCHARSET UTF8 src/PlainCEETimer.Setup/Setup.nsi
      
      - name: Delete Previous Pre-Release
        uses: 8Mi-Tech/delete-release-assets-action@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: Preview
          deleteOnlyFromDrafts: false

      - name: Update Tag
        uses: richardsimko/update-tag@v1
        with:
          tag_name: Preview
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout PlainCEETimerStatic
        uses: actions/checkout@v4
        with:
          repository: WangHaonie/PlainCEETimerStatic
          ssh-key: ${{ secrets.TRIGGER_PRIVATE_KEY }}
          path: PlainCEETimerStatic

      - name: Push to PlainCEETimerStatic
        run: |
          $date = (Get-Content -Raw -Encoding UTF8 "date.txt").Trim()
          $size = $((Get-Item 'src/PlainCEETimer.Setup/PlainCEETimer_${{ steps.read_version.outputs.version }}_x64_Setup.exe').Length)
          ./.github/build/wfutil.exe -FormatChangelogs ".github/build/stable-changelog.txt" "changelog.txt"
          $log = (Get-Content -Raw -Encoding UTF8 "changelog.txt").Trim()
          $loc = [Math]::Round((cloc src --include-lang="C/C++ Header,C#,C++" --json | ConvertFrom-Json).SUM.code / 1000, 1)
          cloc src --include-lang="C/C++ Header,C#,C++" --by-file --md --out loc.md

          cd PlainCEETimerStatic

          git config user.name "WangHaonie"
          git config user.email "68315280+WangHaonie@users.noreply.github.com"

          md badges -ErrorAction Ignore
          curl "https://img.shields.io/badge/%E4%BB%A3%E7%A0%81%E9%87%8F-${loc}k-blue" >badges\loc.svg

          md md -ErrorAction Ignore
          Copy-Item -Path "../loc.md" -Destination "md/loc.md"

          md api -ErrorAction Ignore
          $json = @"
          {"name":"${{ steps.read_version.outputs.version }}","published_at":"$date","body":"$log","size":$size,"commit":"${{ steps.read_version.outputs.sha }}"}
          "@ >api\ci.json

          md download/ci -ErrorAction Ignore
          Get-ChildItem -LiteralPath "download/ci" -File | Remove-Item -Force -ErrorAction Stop
          Copy-Item -Path "../src/PlainCEETimer.Setup/PlainCEETimer_${{ steps.read_version.outputs.version }}_x64_Setup.exe" -Destination "download/ci/CEETimerCSharpWinForms_${{ steps.read_version.outputs.version }}_x64_Setup.exe"

          git add .
          git commit -m "ci: WangHaonie/PlainCEETimer@${{ steps.read_version.outputs.sha }}"
          git push

      - name: Upload to Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: Preview
          files: |
            src/PlainCEETimer.Setup/PlainCEETimer_${{ steps.read_version.outputs.version }}_x64_Setup.exe
          prerelease: true
          body_path: content.txt
